<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²½ê¸° ê¸°ë¡ ì…ë ¥</title>
  <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Select2 CSS ì¶”ê°€ -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* ì¶”ê°€ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    body {
      background-color: #f4f4f4;
    }
    h1 {
      margin-top: 20px;
    }
    .team-box {
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .kda-container {
      display: flex;
      gap: 5px;
    }
    .kda-container input {
      width: 33%;
    }
    /* Select2 ìŠ¤íƒ€ì¼ ì¡°ì • */
    .select2-container {
      width: 100% !important;
      margin-bottom: 5px;
    }
    .select2-container--default .select2-selection--single {
      height: 38px;
      border-radius: 0.375rem;
      border: 1px solid #ced4da;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 36px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 36px;
    }
    /* ì„±ê³µ ë©”ì‹œì§€ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
    .alert-success {
      animation: fadeOut 5s forwards;
      margin-bottom: 20px;
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <h1 class="text-center mb-4">âš” ê²½ê¸° ê¸°ë¡ ì…ë ¥ (KDA, ì±”í”¼ì–¸ í¬í•¨)</h1>

        <!-- ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ -->
    {% if success_message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <strong>{{ success_message }}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    <form action="/record" method="POST" class="bg-white p-4 rounded shadow" id="recordForm">
      <!-- ê²½ê¸° ë‚ ì§œ -->
      <div class="mb-3">
        <label for="match_date" class="form-label">ê²½ê¸° ë‚ ì§œ</label>
        <input type="date" id="match_date" name="match_date" class="form-control" value="{{ form_data.match_date if form_data else '' }}" required>
      </div>
      
      <!-- íŒ€ êµì²´ ë²„íŠ¼ -->
      <div class="text-center mb-3">
        <button type="button" id="swapTeams" class="btn btn-warning">ğŸ”„ ë¸”ë£¨/ë ˆë“œ ë³€í™˜</button>
      </div>

      <div class="row">
        <!-- ë¸”ë£¨íŒ€ -->
        <div class="col-md-6">
          <div class="p-3 mb-3" style="background-color: #ADD8E6; border-radius: 8px;">
            <h2 class="text-primary">ğŸ”¹ ë¸”ë£¨íŒ€</h2>

            <!-- TOP -->
            <div class="mb-3 position-section">
              <label class="form-label">TOP</label>
              <select name="blue_top" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.blue_top == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_top_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_top_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_top_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_top_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>

            <!-- JUNGLE -->
            <div class="mb-3 position-section">
              <label class="form-label">JUNGLE</label>
              <select name="blue_jungle" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.blue_jungle == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_jungle_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_jungle_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_jungle_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_jungle_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>

            <!-- MID -->
            <div class="mb-3 position-section">
              <label class="form-label">MID</label>
              <select name="blue_mid" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.blue_mid == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_mid_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_mid_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_mid_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_mid_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>

            <!-- ADC -->
            <div class="mb-3 position-section">
              <label class="form-label">ADC</label>
              <select name="blue_adc" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.blue_adc == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_adc_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_adc_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_adc_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_adc_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>

            <!-- SUPPORT -->
            <div class="mb-3 position-section">
              <label class="form-label">SUPPORT</label>
              <select name="blue_support" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.blue_support == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_support_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_support_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_support_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="blue_support_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>
          </div>
        </div>

        <!-- ë ˆë“œíŒ€ -->
        <div class="col-md-6">
          <div class="p-3 mb-3" style="background-color: #FFB6C1; border-radius: 8px;">
            <h2 class="text-danger">ğŸ”º ë ˆë“œíŒ€</h2>

            <!-- TOP -->
            <div class="mb-3 position-section">
              <label class="form-label">TOP</label>
              <select name="red_top" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.red_top == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_top_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_top_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_top_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_top_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>

            <!-- JUNGLE -->
            <div class="mb-3 position-section">
              <label class="form-label">JUNGLE</label>
              <select name="red_jungle" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.red_jungle == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_jungle_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_jungle_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_jungle_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_jungle_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>

            <!-- MID -->
            <div class="mb-3 position-section">
              <label class="form-label">MID</label>
              <select name="red_mid" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.red_mid == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_mid_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_mid_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_mid_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_mid_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>

            <!-- ADC -->
            <div class="mb-3 position-section">
              <label class="form-label">ADC</label>
              <select name="red_adc" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.red_adc == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_adc_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_adc_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_adc_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_adc_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>

            <!-- SUPPORT -->
            <div class="mb-3 position-section">
              <label class="form-label">SUPPORT</label>
              <select name="red_support" class="player-select form-select mb-1" required>
                <option value="" disabled selected>í”Œë ˆì´ì–´ ì„ íƒ</option>
                {% for p in players %}
                <option value="{{ p }}" {% if form_data and form_data.red_support == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_support_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>ì±”í”¼ì–¸ ì„ íƒ</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_support_kills" placeholder="í‚¬" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_support_deaths" placeholder="ë°ìŠ¤" min="0" class="form-control kda-field" value="0">
                <input type="number" name="red_support_assists" placeholder="ì–´ì‹œ" min="0" class="form-control kda-field" value="0">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ìŠ¹ë¦¬ íŒ€ ì„ íƒ -->
      <div class="mb-3 text-center">
        <h4>ğŸ† ìŠ¹ë¦¬ íŒ€</h4>
        <select id="winner" name="winner" class="form-select w-50 mx-auto" required>
          <option value="" selected disabled>ì„ íƒí•˜ì„¸ìš”</option>
          <option value="blue">ë¸”ë£¨íŒ€</option>
          <option value="red">ë ˆë“œíŒ€</option>
        </select>
      </div>

      <!-- ì œì¶œ ë° ê¸°ëŠ¥ ë²„íŠ¼ -->
      <div class="text-center">
        <button type="submit" class="btn btn-success px-4 py-2 me-2">ê²½ê¸° ê¸°ë¡ ì €ì¥</button>
        <button type="button" id="resetAll" class="btn btn-secondary px-4 py-2">ì „ì²´ ì´ˆê¸°í™”</button>
        <a href="/" class="btn btn-primary px-4 py-2 ms-2">ğŸ  í™ˆìœ¼ë¡œ</a>
      </div>
    </form>
  </div>

  <!-- jQuery ì¶”ê°€ -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Select2 JS ì¶”ê°€ -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <script>
    $(document).ready(function() {
      
      // ë°ì´í„° ì†ì„±ì„ í†µí•´ ì„±ê³µ ë©”ì‹œì§€ ìœ ë¬´ í™•ì¸
      var hasSuccessMessage = document.body.dataset.hasSuccessMessage === 'true';
      
      if (hasSuccessMessage) {
      resetChampionsAndKDA();
      }

      // í¼ ì œì¶œ ì‹œ ë°ì´í„° ì €ì¥
      const formElement = document.getElementById('recordForm');
      
      // ë‚ ì§œ ê°’ì´ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
      const today = new Date().toISOString().slice(0, 10);
      if (!$('#match_date').val()) {
        $('#match_date').val(today);
      }
      
      // ì „ì²´ í•„ë“œë¥¼ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
      function resetAllFields() {
        // ë‚ ì§œ í•„ë“œ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        const today = new Date().toISOString().slice(0, 10);
        $('#match_date').val(today);
        
        // í”Œë ˆì´ì–´ í•„ë“œ ì´ˆê¸°í™”
        $('.player-select').val(null).trigger('change');
        
        // ì±”í”¼ì–¸ í•„ë“œ ì´ˆê¸°í™”
        $('.champion-select').val(null).trigger('change');
        
        // KDA í•„ë“œ ì´ˆê¸°í™”
        $('.kda-field').val(0);
        
        // ìŠ¹ë¦¬ íŒ€ ì´ˆê¸°í™”
        $('#winner').val('');
      }
      
      // ì±”í”¼ì–¸ê³¼ KDAë§Œ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
      function resetChampionsAndKDA() {
        // ì±”í”¼ì–¸ í•„ë“œ ì´ˆê¸°í™”
        $('.champion-select').val(null).trigger('change');
        
        // KDA í•„ë“œ ì´ˆê¸°í™”
        $('.kda-field').val(0);
      }
      
      // Select2 ì´ˆê¸°í™”
      $('.player-select, .champion-select').select2({
        placeholder: "ì„ íƒí•˜ì„¸ìš”",
        allowClear: true,
        language: {
          noResults: function() { return "ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤"; },
          searching: function() { return "ê²€ìƒ‰ ì¤‘..."; }
        }
      });
      
      // ë¸”ë£¨/ë ˆë“œ ë³€í™˜ ë²„íŠ¼ ê¸°ëŠ¥
      $('#swapTeams').on('click', function() {
        swapTeams();
      });
      
      // ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼
      $('#resetAll').on('click', function() {
        resetAllFields();
      });
      
      // ë¸”ë£¨íŒ€ê³¼ ë ˆë“œíŒ€ ë°ì´í„° êµí™˜ í•¨ìˆ˜
      function swapTeams() {
        const positions = ['top', 'jungle', 'mid', 'adc', 'support'];
        
        positions.forEach(function(position) {
          // í”Œë ˆì´ì–´ ê°’ êµí™˜
          const bluePlayer = $(`select[name="blue_${position}"]`).val();
          const redPlayer = $(`select[name="red_${position}"]`).val();
          
          $(`select[name="blue_${position}"]`).val(redPlayer).trigger('change');
          $(`select[name="red_${position}"]`).val(bluePlayer).trigger('change');
          
          // ì±”í”¼ì–¸ ê°’ êµí™˜
          const blueChampion = $(`select[name="blue_${position}_champion"]`).val();
          const redChampion = $(`select[name="red_${position}_champion"]`).val();
          
          $(`select[name="blue_${position}_champion"]`).val(redChampion).trigger('change');
          $(`select[name="red_${position}_champion"]`).val(blueChampion).trigger('change');
          
          // KDA ê°’ êµí™˜
          const blueKills = $(`input[name="blue_${position}_kills"]`).val();
          const blueDeaths = $(`input[name="blue_${position}_deaths"]`).val();
          const blueAssists = $(`input[name="blue_${position}_assists"]`).val();
          
          const redKills = $(`input[name="red_${position}_kills"]`).val();
          const redDeaths = $(`input[name="red_${position}_deaths"]`).val();
          const redAssists = $(`input[name="red_${position}_assists"]`).val();
          
          $(`input[name="blue_${position}_kills"]`).val(redKills);
          $(`input[name="blue_${position}_deaths"]`).val(redDeaths);
          $(`input[name="blue_${position}_assists"]`).val(redAssists);
          
          $(`input[name="red_${position}_kills"]`).val(blueKills);
          $(`input[name="red_${position}_deaths"]`).val(blueDeaths);
          $(`input[name="red_${position}_assists"]`).val(blueAssists);
        });
        
        // ìŠ¹ë¦¬ íŒ€ ê°’ êµí™˜
        const winner = $('#winner').val();
        if (winner === 'blue') {
          $('#winner').val('red');
        } else if (winner === 'red') {
          $('#winner').val('blue');
        }
      }
      
      
      
      // í¼ ìš”ì†Œì— í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸
      $(document).on('focus', '.select2-selection', function(e) {
        const containerId = $(this).closest('.select2-container').attr('id');
        const selectId = containerId.replace('select2-', '').replace('-container', '');
        const $select = $(`#${selectId}`);
        
        if ($select.length) {
          $select.select2('open');
          setTimeout(function() {
            $('.select2-search__field:visible').focus();
          }, 50);
        }
      });
      
      // ì—”í„°í‚¤ ì²˜ë¦¬
      $('.player-select, .champion-select').on('keydown', function(e) {
        if (e.key === 'Enter' && !$('.select2-search__field:visible').length) {
          e.preventDefault();
          $(this).select2('open');
        }
      });
      
      // KDA í•„ë“œ íƒ­ ì´ë™ ì²˜ë¦¬
      $('.kda-container input:last-child').on('keydown', function(e) {
        if (e.key === 'Tab' && !e.shiftKey) {
          const $currentSection = $(this).closest('.position-section');
          const $nextSection = $currentSection.next('.position-section');
          
          if ($nextSection.length) {
            e.preventDefault();
            const $nextSelect = $nextSection.find('.player-select');
            $nextSelect.focus();
            $nextSelect.select2('open');
          }
        }
      });
      
      // ìŠ¹ë¦¬ íŒ€ ì„ íƒ ìë™ ë“œë¡­ë‹¤ìš´
      $('#winner').on('focus', function() {
        $(this).click();
      });
      
      // ê²€ìƒ‰ í•„ë“œ ìë™ í¬ì»¤ìŠ¤
      $(document).on('select2:open', function() {
        setTimeout(() => {
          document.querySelector('.select2-container--open .select2-search__field').focus();
        }, 10);
      });
      
      // ì²« ë²ˆì§¸ ìš”ì†Œì— í¬ì»¤ìŠ¤
      setTimeout(function() {
        if (!$('.player-select:first').val()) {
          $('.player-select:first').focus();
        }
      }, 500);
    });
  </script>
</body>
</html>