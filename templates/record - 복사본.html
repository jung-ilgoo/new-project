<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>경기 기록 입력</title>
  <!-- 부트스트랩 CSS CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Select2 CSS 추가 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    /* 추가 커스텀 스타일 */
    body {
      background-color: #f4f4f4;
    }
    h1 {
      margin-top: 20px;
    }
    .team-box {
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .kda-container {
      display: flex;
      gap: 5px;
    }
    .kda-container input {
      width: 33%;
    }
    /* Select2 스타일 조정 */
    .select2-container {
      width: 100% !important;
      margin-bottom: 5px;
    }
    .select2-container--default .select2-selection--single {
      height: 38px;
      border-radius: 0.375rem;
      border: 1px solid #ced4da;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 36px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 36px;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <h1 class="text-center mb-4">⚔ 경기 기록 입력 (KDA, 챔피언 포함)</h1>
    
    <form action="/record" method="POST" class="bg-white p-4 rounded shadow">
      <!-- 경기 날짜 -->
      <div class="mb-3">
        <label for="match_date" class="form-label">경기 날짜</label>
        <input type="date" id="match_date" name="match_date" class="form-control" required>
      </div>

      <div class="row">
        <!-- 블루팀 -->
        <div class="col-md-6">
          <div class="p-3 mb-3" style="background-color: #ADD8E6; border-radius: 8px;">
            <h2 class="text-primary">🔹 블루팀</h2>

            <!-- TOP -->
            <div class="mb-3">
              <label class="form-label">TOP</label>
              <select name="blue_top" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_top_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_top_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="blue_top_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="blue_top_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>

            <!-- JUNGLE -->
            <div class="mb-3">
              <label class="form-label">JUNGLE</label>
              <select name="blue_jungle" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_jungle_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_jungle_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="blue_jungle_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="blue_jungle_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>

            <!-- MID -->
            <div class="mb-3">
              <label class="form-label">MID</label>
              <select name="blue_mid" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_mid_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_mid_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="blue_mid_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="blue_mid_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>

            <!-- ADC -->
            <div class="mb-3">
              <label class="form-label">ADC</label>
              <select name="blue_adc" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_adc_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_adc_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="blue_adc_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="blue_adc_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>

            <!-- SUPPORT -->
            <div class="mb-3">
              <label class="form-label">SUPPORT</label>
              <select name="blue_support" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="blue_support_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="blue_support_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="blue_support_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="blue_support_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>
          </div>
        </div>

        <!-- 레드팀 -->
        <div class="col-md-6">
          <div class="p-3 mb-3" style="background-color: #FFB6C1; border-radius: 8px;">
            <h2 class="text-danger">🔺 레드팀</h2>

            <!-- TOP -->
            <div class="mb-3">
              <label class="form-label">TOP</label>
              <select name="red_top" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_top_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_top_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="red_top_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="red_top_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>

            <!-- JUNGLE -->
            <div class="mb-3">
              <label class="form-label">JUNGLE</label>
              <select name="red_jungle" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_jungle_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_jungle_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="red_jungle_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="red_jungle_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>

            <!-- MID -->
            <div class="mb-3">
              <label class="form-label">MID</label>
              <select name="red_mid" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_mid_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_mid_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="red_mid_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="red_mid_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>

            <!-- ADC -->
            <div class="mb-3">
              <label class="form-label">ADC</label>
              <select name="red_adc" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_adc_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_adc_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="red_adc_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="red_adc_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>

            <!-- SUPPORT -->
            <div class="mb-3">
              <label class="form-label">SUPPORT</label>
              <select name="red_support" class="player-select form-select mb-1" required>
                <option value="" disabled selected>플레이어 선택</option>
                {% for p in players %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <select name="red_support_champion" class="champion-select form-select mb-1" required>
                <option value="" disabled selected>챔피언 선택</option>
                {% for c in champions %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <div class="kda-container">
                <input type="number" name="red_support_kills" placeholder="킬" min="0" class="form-control" value="">
                <input type="number" name="red_support_deaths" placeholder="데스" min="0" class="form-control" value="">
                <input type="number" name="red_support_assists" placeholder="어시" min="0" class="form-control" value="">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 승리 팀 선택 -->
      <div class="mb-3 text-center">
        <h4>🏆 승리 팀</h4>
        <select id="winner" name="winner" class="form-select w-50 mx-auto" required>
          <option value="" selected disabled>선택하세요</option>
          <option value="blue">블루팀</option>
          <option value="red">레드팀</option>
        </select>
      </div>

      <!-- 제출 버튼 -->
      <div class="text-center">
        <button type="submit" class="btn btn-success px-4 py-2">경기 기록 저장</button>
      </div>
    </form>
  </div>
<!-- 기존 HTML 부분은 유지하고 스크립트 부분만 교체할 것입니다 -->

<!-- jQuery 추가 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- 부트스트랩 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Select2 JS 추가 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- 검색 기능 초기화 -->
  <script>
      $(document).ready(function() {
        // 기본적인 Select2 설정에서 여러 옵션을 최소화하여 기본 동작에 가깝게 유지
        $('.player-select, .champion-select').select2({
          placeholder: "선택하세요",
          allowClear: true,
          // selectOnClose 옵션 제거
          language: {
            noResults: function() {
              return "결과가 없습니다";
            },
            searching: function() {
              return "검색 중...";
            }
          }
        });
        
        // 전역 이벤트 리스너를 추가하여 DOM 변화를 감지
        $(document).on('focus', '.select2-selection', function(e) {
          // Select2 컨테이너 요소의 ID 가져오기 
          const containerId = $(this).closest('.select2-container').attr('id');
          // ID에서 원래 select 요소의 ID 추출
          const selectId = containerId.replace('select2-', '').replace('-container', '');
          // 원래 select 요소 찾기
          const $select = $(`#${selectId}`);
          
          // 탭 키가 눌렸을 때만 자동으로 드롭다운 열기
          if ($select.length) {
            // 드롭다운 열기
            $select.select2('open');
            
            // 모든 드롭다운이 열린 후 검색 필드에 포커스 주기
            setTimeout(function() {
              $('.select2-search__field:visible').focus();
            }, 50);
          }
        });
        
        // 각 select 요소에 직접 keydown 핸들러 추가
        $('.player-select, .champion-select').on('keydown', function(e) {
          // 엔터 키 처리 - 드롭다운 토글
          if (e.key === 'Enter' && !$('.select2-search__field:visible').length) {
            e.preventDefault();
            $(this).select2('open');
            return;
          }
        });
        
        // KDA 입력 필드가 탭으로 넘어갈 때 다음 필드/섹션으로 적절히 이동
        $('.kda-container input:last-child').on('keydown', function(e) {
          if (e.key === 'Tab' && !e.shiftKey) {
            const $currentSection = $(this).closest('.mb-3');
            const $nextSection = $currentSection.next('.mb-3');
            
            if ($nextSection.length) {
              // 다음 포지션이 있는 경우
              // 탭 동작을 막고 명시적으로 포커스 이동
              e.preventDefault();
              const $nextSelect = $nextSection.find('.player-select');
              $nextSelect.focus();
              $nextSelect.select2('open');
            }
          }
        });
        
        // 승리 팀 선택도 포커스 받을 때 자동으로 드롭다운 열기
        $('#winner').on('focus', function() {
          $(this).click();
        });
        
        // Select2 열릴 때 항상 검색 필드 포커스
        $(document).on('select2:open', function() {
          setTimeout(() => {
            document.querySelector('.select2-container--open .select2-search__field').focus();
          }, 10);
        });
        
        // Tab 키가 일반적인 동작을 벗어날 때를 위한 보조 이벤트 핸들러
        $(document).on('keydown', function(e) {
          if (e.key === 'Tab') {
            // 약간의 지연 후 확인
            setTimeout(function() {
              const $focused = $(':focus');
              
              // 만약 포커스된 요소가 select2 컨테이너라면
              if ($focused.hasClass('select2-selection')) {
                const $select = $focused.closest('.select2-container').siblings('select');
                if ($select.length) {
                  $select.select2('open');
                }
              }
            }, 0);
          }
        });
        
        // 특별히 첫 번째 요소에 포커스 - 페이지 로드 시 자동 포커스
        setTimeout(function() {
          $('input[name="match_date"]').focus();
        }, 500);
      });
  </script>
</body>
</html>